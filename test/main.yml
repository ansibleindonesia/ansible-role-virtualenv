---

- hosts: all
  vars:
    test_path: "{{'./tmp'|realpath}}"
    virtualenv_path: "{{test_path}}/env"
  pre_tasks:
    - name: remove virtualenv path
      file:
        path: "{{virtualenv_path}}"
        state: absent
    - name: create test directory
      file:
        path: "{{test_path}}"
        state: directory
    - name: create test requirements file
      copy:
        content: |
          decorator
          requests
        dest: "{{test_path}}/requirements.txt"
  roles:
    - role: cchurch.virtualenv
      virtualenv_notify_on_updated: "virtualenv handler created"
    - role: cchurch.virtualenv
      virtualenv_notify_on_updated: "virtualenv handler no change"
    - role: cchurch.virtualenv
      virtualenv_notify_on_updated: "virtualenv handler recreated"
      virtualenv_recreate: true
    - role: cchurch.virtualenv
      virtualenv_pre_packages:
        - pytz
      virtualenv_notify_on_updated: "virtualenv handler pre packages"
    - role: cchurch.virtualenv
      virtualenv_pre_packages:
        - name: pytz
          version: "2014.4"
      virtualenv_notify_on_updated: "virtualenv handler pre packages downgrade"
    - role: cchurch.virtualenv
      virtualenv_requirements:
        - "{{test_path}}/requirements.txt"
      virtualenv_notify_on_updated: "virtualenv handler requirements"
    - role: cchurch.virtualenv
      virtualenv_post_packages:
        - name: pytz
          state: absent
      virtualenv_notify_on_updated: "virtualenv handler post packages"

  handlers:
    - name: virtualenv handler created
      set_fact:
        virtualenv_notified_created: true
      changed_when: true
      notify:
        - foo handler
        - bar handler
    - name: foo handler
      set_fact:
        foo_notified: true
    - name: bar handler
      set_fact:
        bar_notified: true
    - name: virtualenv handler no change
      set_fact:
        virtualenv_notified_no_change: true
    - name: virtualenv handler recreated
      set_fact:
        virtualenv_notified_recreated: true
    - name: virtualenv handler pre packages
      set_fact:
        virtualenv_notified_pre_packages: true
    - name: virtualenv handler pre packages downgrade
      set_fact:
        virtualenv_notified_pre_packages_downgrade: true
    - name: virtualenv handler requirements
      set_fact:
        virtualenv_notified_requirements: true
    - name: virtualenv handler post packages
      set_fact:
        virtualenv_notified_post_packages: true

- hosts: all
  tasks:
    - assert:
        that:
          - virtualenv_notified_created
          - foo_notified
          - bar_notified
          #- virtualenv_notified_no_change is not defined
          - virtualenv_notified_recreated
          - virtualenv_notified_pre_packages
          - virtualenv_notified_pre_packages_downgrade
          - virtualenv_notified_requirements
          - virtualenv_notified_post_packages
