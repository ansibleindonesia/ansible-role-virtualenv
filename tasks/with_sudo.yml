---

- name: remove existing virtualenv with sudo
  file:
    path: '{{virtualenv_path}}'
    state: absent
  when: virtualenv_recreate
  sudo: yes
  sudo_user: '{{virtualenv_user}}'

- name: create virtualenv with sudo
  pip:
    name: wsgiref
    virtualenv: '{{virtualenv_path}}'
    virtualenv_command: '{{virtualenv_command|default(omit)}}'
    virtualenv_site_packages: '{{virtualenv_site_packages|default(omit)}}'
  sudo: yes
  sudo_user: '{{virtualenv_user}}'
  register: virtualenv_create_result
  changed_when: virtualenv_create_result|success and virtualenv_create_result.stdout|match('^New.*')
  notify: '{{virtualenv_notify_on_updated|default("virtualenv default handler",true)}}'

- name: install virtualenv pre packages with sudo
  pip:
    name: '{{item.name|default(item,true)}}'
    version: '{{item.version|default(omit,true)}}'
    state: '{{item.state|default("present",true)}}'
    virtualenv: '{{virtualenv_path}}'
  with_items: virtualenv_pre_packages
  sudo: yes
  sudo_user: '{{virtualenv_user}}'
  notify: '{{virtualenv_notify_on_updated|default("virtualenv default handler",true)}}'

- name: install virtualenv requirements with sudo
  pip:
    requirements: '{{item}}'
    virtualenv: '{{virtualenv_path}}'
  with_items: virtualenv_requirements
  sudo: yes
  sudo_user: '{{virtualenv_user}}'
  notify: '{{virtualenv_notify_on_updated|default("virtualenv default handler",true)}}'

- name: install virtualenv post packages with sudo
  pip:
    name: '{{item.name|default(item,true)}}'
    version: '{{item.version|default(omit,true)}}'
    state: '{{item.state|default("present",true)}}'
    virtualenv: '{{virtualenv_path}}'
  with_items: virtualenv_post_packages
  sudo: yes
  sudo_user: '{{virtualenv_user}}'
  notify: '{{virtualenv_notify_on_updated|default("virtualenv default handler",true)}}'
